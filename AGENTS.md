# Repository Guidelines

This document complements `MASTER_DOCUMENTATION.md`, which contains a full architectural map, tooling catalog, and operational playbooks. Refer back there whenever you need deeper context on a rule defined below.

## 1. Project Structure & Ownership
- **Source Code**: `src/`
  - `components/`, `pages/`, `routes/`, `hooks/`, `services/`, `contexts/`, `utils/`, `styles/`
- **Public Assets & PWA**: `public/` (includes icons, `manifest.json`, service worker files)
- **Build Output**: `dist/` (generated by Vite — never commit manual changes)
- **Reference Material**: `docs/`, `database/`, `migrations/`, plus root-level `*.md` reports (audits, guides, summaries)
- **Scripts & Tooling**: Root `*.js/.cjs` files and `scripts/` directory contain diagnostics and maintenance tooling (see Section 13 of `MASTER_DOCUMENTATION.md`).

## 2. Environment & Configuration
- Copy `.env.example` to `.env.development` before running locally. Keep credentials in sync with Supabase project settings.
- Only expose variables via `VITE_*` prefixes (e.g., `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`).
- Never commit secrets — `.env*` files are git-ignored by design.
- PWA files (`public/manifest.json`, service worker) must be updated together with icon assets.

## 3. Development Workflow
- Use pnpm per the workspace lockfile (`pnpm@10.15.0`). Common commands (`package.json`):
  - `pnpm dev` / `pnpm dev:5173`
  - `pnpm build`, `pnpm preview`
  - `pnpm lint`, `pnpm analyze`
  - `pnpm clean`, `pnpm clean:all`
- Prior to pushing or opening a PR, run `pnpm lint` and `pnpm build` to ensure code quality and bundle integrity.
- For preview deployments, prefix commits with `[preview]` to trigger the appropriate automation flows.

## 4. Coding Style & Naming Conventions
- Language: TypeScript + React 18 (functional components only).
- **Indentation**: 2 spaces (respect Prettier/Tailwind class ordering guidelines).
- **Files & Symbols**:
  - Components: PascalCase (`OrderTable.tsx`, `MobileLayout.tsx`)
  - Hooks: `useXxx` (`useAuthLifecycle.ts`, `useSafeCurrency.ts`)
  - Utilities/constants: camelCase (`formatNumber`, `refreshSessionSafely`)
- **Imports**: Group external modules, local modules, and styles separately; remove unused imports immediately.
- **Tailwind**: Prefer composable utility classes; maintain readability by grouping related classes (layout, typography, state).
- **Module-specific rule**: In Orders/Recipes domains, persist API payload fields using `snake_case` (enforced via `eslint.config.js`).

## 5. Auth & Session Safety
- All mutations of session/user pairs must use `updateAuthState(session, user)` (`src/hooks/auth/useAuthState.ts`).
- Do **not** call Supabase `refreshSession()` directly; instead rely on `silentRefreshSession()` and `refreshSessionSafely()` from `src/utils/auth/refreshSession.ts`.
- Local storage access for auth/session data must go through `safeStorageSet`, `safeStorageGet`, `safeStorageRemove` (`src/utils/auth/safeStorage.ts`).
- Avoid duplicating Supabase `onAuthStateChange` listeners; use centralized observers in `AuthContext` and `useAuthLifecycle`.
- When handling tab visibility or navigation restoration, update `app:last-path` via safe storage helpers (see `useAuthLifecycle.ts`).
- For periodic refresh behavior, rely on `periodicSessionRefresh` singleton (`src/utils/auth/periodicSessionRefresh.ts`) to respect inactivity windows.
- See `RACE_CONDITION_ELIMINATION_GUIDE.md` and Section 3 of `MASTER_DOCUMENTATION.md` for full rationale.

## 6. UI & Layout Standards
- Application chrome lives in `src/components/layout/` (`AppLayout`, `MobileLayout`, `DesktopLayout`). Keep mobile-first considerations in sync across layouts.
- Shared UI elements (buttons, inputs, dialogs) live under `src/components/ui/`. Avoid one-off styling outside of these components.
- Use `useSafeCurrency()` (`src/hooks/useSafeCurrency.ts`) whenever formatting currency values to prevent context availability issues in lazy-loaded chunks.
- Keep accessibility in mind: prefer semantic HTML, use Radix primitives (`@radix-ui/react-*`) for modals and overlays, and follow guidelines captured in `DIALOG_ACCESSIBILITY_FIX.md`.

## 7. Testing & Quality Assurance
- No formal unit testing framework; rely on dedicated scenario scripts in the repo root (`browser-test.js`, `bulk-operations-test.js`, `test-order-status.js`, etc.).
- When touching domain logic, run the relevant scenario scripts and note results in the PR description.
- Keep exploratory or demo pages under `src/` prefixed with `test-` (e.g., `src/test-calendar-page.tsx`). Remove them when no longer needed.
- Verify critical routes (`src/routes/`) and contexts (`src/contexts/`) before merging.
- Document manual QA steps in PRs, including browsers/devices covered.

## 8. Commit & Pull Request Guidelines
- Use short, imperative commit messages (e.g., `Add`, `Fix`, `Update`). Optional prefixes (`feat:`, `fix:`) are welcome.
- When changing behavior, include bullet points in the commit body (or PR description) explaining scope and rationale.
- PR requirements:
  - Clear summary with links to tickets/issues.
  - Screenshots/GIFs for UI changes.
  - Explicit testing checklist (commands run, scenario scripts executed).
  - Confirmation that `pnpm lint` and `pnpm build` succeeded.
- Do not merge failing builds or lint checks. Engage reviewers if you need exceptions.

## 9. Documentation Expectations
- Major architectural or feature changes must be reflected in `MASTER_DOCUMENTATION.md` or by adding a dedicated markdown file in the repo root.
- Update existing docs (e.g., `RACE_CONDITION_ELIMINATION_GUIDE.md`, `PANDUAN_PENGGUNAAN.md`) when workflows change.
- When introducing new scripts or maintenance procedures, document usage and purpose adjacent to the script (inline comments + supporting `.md`).
- Keep README badges, quick start instructions, and command references current when tooling changes.

## 10. Troubleshooting Resources
- **Supabase Issues**: Refer to `test-supabase-connection.cjs`, `AUTH_SECURITY_SUMMARY.md`, and `Troubleshooting` docs (root) for known failure modes.
- **Currency/Formatting Bugs**: `useSafeCurrency.ts`, `CurrencyInput.tsx`, and the associated fix notes highlighted in team memory (lazy-loaded contexts).
- **Financial Stitching**: Utilities and scripts in `src/utils/orderFinancialSync.ts` and `FINANCIAL_SYNC_TEST_GUIDE.md`.
- **Warehouse Diagnostics**: `warehouse-diagnostic.js`, `WAREHOUSE_*` documentation files.
- See Section 12 of `MASTER_DOCUMENTATION.md` for more playbooks.

## 11. Housekeeping
- Remove unused files, especially generated bundles or artifacts, before committing.
- Keep dependencies tidy with `pnpm update --latest` only after verifying compatibility; document any major dependency upgrades.
- Ensure `public/version.json` stays in sync with builds (generated via `scripts/generate-version.js`).
- For PWA/service worker changes, coordinate updates across `manifest.json`, icon sets, and caching strategies.

---

Following these guidelines keeps the project safe, consistent, and aligned with the race-condition mitigation work already in place. When in doubt, consult `MASTER_DOCUMENTATION.md` or raise a discussion in the team channel before diverging from the standards above.
