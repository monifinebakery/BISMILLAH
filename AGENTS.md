# Repository Guidelines

## Project Structure & Module Organization
- Source: `src/` (key folders: `components/`, `pages/`, `routes/`, `hooks/`, `services/`, `contexts/`, `utils/`, `styles/`).
- Public assets + PWA files: `public/` (icons, `manifest.json`, `sw.js`).
- Builds: `dist/` (generated by Vite; do not edit).
- Docs and SQL: `docs/`, `database/`, `migrations/` for reference and data scripts.

## Build, Test, and Development Commands
- `pnpm dev`: Start the Vite dev server (default port 5174).
- `pnpm build`: Production build to `dist/`.
- `pnpm preview`: Serve the built app locally.
- `pnpm analyze`: Build with bundle analyzer enabled; `analyze:server` also previews.
- `pnpm lint`: Run ESLint checks for TS/React.
- `pnpm clean` / `clean:all`: Remove build caches and dependencies.

## Coding Style & Naming Conventions
- Language: TypeScript + React 18, Vite, TailwindCSS.
- Indentation: 2 spaces; keep imports tidy and remove dead code.
- Components: PascalCase (files and exports). Hooks: `useXxx`. Utilities: camelCase.
- Tailwind: prefer utility classes; keep class strings readable and grouped.
- ESLint: `typescript-eslint`, `react-hooks`, `react-refresh`. Run `pnpm lint` locally.
- Module-specific rule: In Orders/Recipe modules, data fields use `snake_case` (see `eslint.config.js`).

## Testing Guidelines
- No formal unit test runner. Validate flows via the dev server and ad‑hoc scripts.
- Examples: `node browser-test.js`, `node bulk-operations-test.js` (root) for scenario checks.
- Keep demo/test pages under `src/` prefixed with `test-` (e.g., `src/test-calendar-page.tsx`).
- Aim to verify critical routes in `src/routes/` and key contexts in `src/contexts/` before PRs.

## Commit & Pull Request Guidelines
- Commits: Imperative, concise summaries; optional prefixes like `fix:`/`feat:` are welcome.
- Include a brief rationale and scope bullets when changing behavior.
- PRs: clear description, linked issues, screenshots/GIFs for UI, and steps to reproduce/test.
- Required: run `pnpm lint` and `pnpm build` locally; avoid committing `dist/`.

## Race Condition & Thread Safety
- **Authentication:** Use `safeStorage*` functions for auth-related localStorage operations.
- **Session Management:** Never bypass `refreshSession()` - it has mutex protection for concurrent calls.
- **Auth State Updates:** Always use `updateAuthState(session, user)` for atomic updates, never separate updates.
- **Event Handlers:** Avoid multiple `onAuthStateChange` subscriptions - causes race conditions.
- **Storage Access:** Use `safeStorageSet/Get/Remove` instead of direct `localStorage` for critical data.
- **Critical Files:** 
  - `src/services/auth/core/session.ts` - Mutex-protected session operations
  - `src/utils/auth/safeStorage.ts` - Thread-safe storage utilities
  - `src/hooks/auth/useAuthState.ts` - Atomic auth state management
- **Testing:** Test concurrent scenarios (rapid tab switching, simultaneous auth operations).
- **Documentation:** See `RACE_CONDITION_ELIMINATION_GUIDE.md` for detailed implementation.

## Security & Configuration Tips
- Env files: copy `.env.example` to `.env.development` for local use.
- Vite exposes only `VITE_`‑prefixed vars. Example: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`.
- Do not commit secrets; `.env*` is git‑ignored.
